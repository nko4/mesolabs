<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Walk-Sharing</title>
  <link rel='stylesheet' href='/stylesheets/main.css' />
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&key=AIzaSyBqVrhEMODzAqARXW18d-5UMzMqEMbQgZ4&sensor=false"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
  <script src="/javascripts/common.js"></script>
  <script src="/javascripts/comment.js"></script>
  <script src="http://nko-analytics.2013.nodeknockout.com/trk.min.js" class="trk-no-ribbon"></script>
  <script src="/javascripts/ifvisible.js"></script>
  <script>

    function initialize() {
      commentCanvasInit();
      var geocoder = new google.maps.Geocoder;
      var request = {address: "{{start}}"};

      geocoder.geocode(request, function (results, status) {
        if (status != google.maps.GeocoderStatus.OK) {
          return console.log("Geocode failed for the following reason: " + status);
        }
        var startLatlng = results[0].geometry.location;
        var map = createMap(startLatlng);
        var pov = {heading: 0, pitch: 0};
        var panorama = createPanorama(startLatlng, pov, true);
        map.setStreetView(panorama);
        addPositionChangedListener(panorama, map, true);
        addPovChangedListener(panorama);

        connection.socket.emit("drive", connection.pathname, startLatlng);

        initialClick(map);
      });
    }
    google.maps.event.addDomListener(window, 'load', initialize);

    var idleTimer;
    ifvisible.on("idle", function() {
      var counter = 10;
      idleTimer = setInterval(function(){
        if(counter < 0) {
          location.href = "/auth/logout";
        }
        counter--;
        console.log("away from table, prease move in " + counter + "seconds.");
        //TODO: 表示
      }, 1000)
    });
    ifvisible.on("wakeup", function() {
      if(idleTimer){
        //TODO: 表示
        console.log("well come back");
        clearInterval(idleTimer);
      }
    });
  </script>
</head>
<body>
  <div id="map-canvas"></div>
  <div id="streetview-canvas"></div>
  <div id="party-canvas">
    <img src="{{icon}}" />{{user}}<br />
  </div>
  <canvas id="comment-canvas"></canvas>
  <form onsubmit="sendChat(); return false;">
    <input id="chat-input" type="text" name="chat" placeholder="Input chat message..." autocomplete="off" />
  </form>
</body>
</html>
