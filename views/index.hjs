<!DOCTYPE html>
<html>
  <head>
    <title>{{ title }}</title>
    <link rel='stylesheet' href='/stylesheets/index.css' />
    <link href='http://fonts.googleapis.com/css?family=Snippet|Codystar|Monofett|Share+Tech+Mono|Ribeye+Marrow|Voltaire' rel='stylesheet' type='text/css'>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&key=AIzaSyBqVrhEMODzAqARXW18d-5UMzMqEMbQgZ4&sensor=false"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>
    <script src="http://nko-analytics.2013.nodeknockout.com/trk.min.js" class="trk-no-ribbon"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/javascripts/comment.js"></script>
    <script>
      function createThumbnailPanorama(latlng, pov, linkControl, div) {
        var panoOptions = {
          position: latlng,
          addressControl: false,
          linksControl: linkControl,
          panControl: false,
          zoomControl: false,
          enableCloseButton: false,
          clickToGo: false,
          disableDoubleClickZoom: false,
          scrollwheel: false,
          pov: pov,
          visible: true
        };
        return new google.maps.StreetViewPanorama(div, panoOptions);
      }

      function initialize() {
        var connection ={};
        connection.socket = io.connect();
        connection.socket.on("push_rooms", function(rooms) {
          if (rooms) {
            var max = $(".thumb").length;
            var i = 0;
            for (var id in rooms) {
              var room = rooms[id];
              var div = $(".thumb")[i];
              var startLatlng = new google.maps.LatLng(room.position.nb, room.position.ob);
              var pov = room.pov;
              var panorama = createThumbnailPanorama(startLatlng, pov, false, div);
              $(div).click(function (){
                console.log("clicked", id);
                $("#wrapper").fadeTo(800, 0.05, function() {
                  $("#wrapper").attr("src", "/" + id).load(function() {
                    $("#wrapper").fadeTo(800, 1);
                  });
                });
                return false;
              });
              i++;
              if (i >= max) break;
            }
          }
        });
        connection.socket.emit("get_rooms");
      }
      google.maps.event.addDomListener(window, 'load', initialize);

    </script>
  </head>
  <body>
    <iframe id="wrapper">
    </iframe>

    <div id="header"></div>
      <div id="container">
        <div id="left-column">
          <div id="toggle-btn">&lt</div>
          <div id="left-column-container">
            <iframe src="http://nodeknockout.com/iframe/mesolabs" frameborder=0 scrolling=no allowtransparency=true width=115 height=25></iframe>
            <h1 id="title">{{ title }}</h1>
            <form>
              <input type="text" name="place" placeholder="Enter start place" />
              <input type="submit" formaction="/new" formmethod="POST" value="START your walk" />
            </form>
            <p id="description">
              aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa
            </p>
            <!--
            <p id="now">&gt Now</p>
            <div id="list">
              <ul>
                <li>
                  <div class="thumb"></div>
                </li>  
                <li>
                  <div class="thumb"></div>
                </li>  
                <li>
                  <div class="thumb"></div>
                </li>  
                <li>
                  <div class="thumb"></div>
                </li>  
                <li>
                  <div class="thumb"></div>
                </li>  
              </ul>
            </div>
            <p id="past">&gt Past</p>
            <div id="list">
              <ul>
                <li>
                  <div class="thumb"></div>
                </li>  
                <li>
                  <div class="thumb"></div>
                </li>  
                <li>
                  <div class="thumb"></div>
                </li>  
                <li>
                  <div class="thumb"></div>
                </li>  
                <li>
                  <div class="thumb"></div>
                </li>  
              </ul>
            -->
            </div>
        </div>
        <div id="bottom-column">
          <div id="menu">
            <div id="menu-container">
              <p id="live">&gt Live</p>
              <p id="time-shift">&gt Time-Shift</p>
            </div>
          </div>
          <div id="list-wrap">
            <div id="list">
              <ul>
                <li>
                  <div class="thumb"></div>
                </li>  
                <li>
                  <div class="thumb"></div>
                </li>  
                <li>
                  <div class="thumb"></div>
                </li>  
                <li>
                  <div class="thumb"></div>
                </li>  
                <li>
                  <div class="thumb"></div>
                </li>  
                <li>
                  <div class="thumb"></div>
                </li>  
                <li>
                  <div class="thumb"></div>
                </li>  
                <li>
                  <div class="thumb"></div>
                </li>  
              </ul>
            </div>
          </div>
        </div>
      </div>
      <div id="footer"></div>
  <script type="text/javascript">
    $(document).ready(function(){
        $("#toggle-btn").click(toggleButtonClickHandler);
        $("input[type='submit']").mouseover(function(){
            $(this).css({
                "box-shadow" : "1px 1px 3px #eee8aa, 1px -1px 3px #eee8aa, -1px 1px 3px #eee8aa, -1px -1px 3px #eee8aa"
            });
        });
        $("input[type='submit']").mouseout(function(){
            $(this).css({
                "box-shadow" : "none"
            });
        });
        $("#left-column #left-column-container #list ul li").mouseover(function(){
            $(this).css({
                "box-shadow" : "1px 1px 3px #eee8aa, 1px -1px 3px #eee8aa, -1px 1px 3px #eee8aa, -1px -1px 3px #eee8aa"
            });
        });
        $("#left-column #left-column-container #list ul li").mouseout(function(){
            $(this).css({
                "box-shadow" : "none"
            });
        });
        
        var li_move = 2;
        $("#list-wrap").prepend('<div id="prev" class="hide"></div>');
        $("#list-wrap").append('<div id="next" class="show"></div>');
        var list_wid = $("#list").width();
        var li_wid = $("#list li").outerWidth();
        var li_num = $("#list li").size();
        var ul_wid = li_wid*li_num;
        $('#list ul').css({
            position: 'absolute',
            top: '0',
            left: '0',
            width: ul_wid+'px'
        });

        $('#prev').click(function(){
            if($(this).attr("class") != "hide") {
                $('#list ul:not(:animated)').animate(
                    {left:'+='+li_wid*li_move},
                    600,
                    function(){
                        var ul_pos = boxPosition("#list ul","left");
                        console.log("prev ---");
                        console.log("ul_pos", ul_pos);
                        $('#next').attr("class","show");
                        if(ul_pos === 0) {
                            $('#prev').attr("class","hide");
                        }
                    }
                );
            }
        });

        $('#next').click(function(){
            if($(this).attr("class") != "hide") {
                $('#list ul:not(:animated)').animate(
                    {left:'-='+li_wid*li_move},
                    600,
                    function(){
                        var ul_pos = boxPosition("#list ul","left");
                        console.log("next ---");
                        console.log("ul_pos", ul_pos);
                        console.log("ul_wid+ul_pos", ul_wid+ul_pos);
                        console.log("list_wid", list_wid);
                        $('#prev').attr("class","show");
                        if(list_wid > (ul_wid+ul_pos)) {
                            $('#next').attr("class","hide");
                        }
                    }
                );
            }
        });

        function boxPosition(ele,pos) {
            var position = $(ele).position();
            return position[pos];
        }

        function toggleButtonClickHandler(){
            if($(this).hasClass("close")){
                //OPEN
                $(this).removeClass("close");
                $("#toggle-btn").html("&lt");
                $("#left-column").css({
                    "filter" : "alpha(opacity=0)",
                    "-moz-opacity" : "0",
                    "opacity" : "0"
                });
                $("#left-column-container").css({
                    "display" : "inline-block",
                });
                $("#bottom-column").css({
                    "display" : "inline-block"
                });
                $("#left-column").animate({
                    "width" : "20%",
                    "filter" : "alpha(opacity=100)",
                    "-moz-opacity" : "1",
                    "opacity" : "1"
                }, 500, function(){
                    $("#left-column").css({
                        "min-width" : "252px"
                    });
                    $("#left-column-container").animate({
                        "filter" : "alpha(opacity=100)",
                        "-moz-opacity" : "1",
                        "opacity" : "1"
                    }, 300);
                });
                $("#bottom-column").animate({
                    "height" : "130px",
                    "filter" : "alpha(opacity=100)",
                    "-moz-opacity" : "1",
                    "opacity" : "1"
                }, 500);
            }else{
                //CLOSE
                $(this).addClass("close");
                $("#left-column-container").animate({
                    "filter" : "alpha(opacity=0)",
                    "-moz-opacity" : "0",
                    "opacity" : "0"
                }, 100, function(){
                    $("#left-column-container").css({
                        "display" : "none"
                    });
                });
                $("#left-column").animate({
                    "width" : "0",
                    "filter" : "alpha(opacity=0)",
                    "-moz-opacity" : "0",
                    "opacity" : "0",
                    "min-width" : "0"
                }, 1000, function(){
                    $("#toggle-btn").html("&gt");
                    $("#left-column").animate({
                        "filter" : "alpha(opacity=1)",
                        "-moz-opacity" : "1",
                        "opacity" : "1"
                    }, 1000);
                });
                $("#bottom-column").animate({
                    "height" : "0",
                    "filter" : "alpha(opacity=0)",
                    "-moz-opacity" : "0",
                    "opacity" : "0"
                }, 1000, function(){
                    $("#bottom-column").css({
                        "display" : "none"
                    });
                });
            }
        }
    });
  </script>
  </body>
</html>
